#!/usr/bin/env bash

reboot="Reboot"
shutdown="Shut down"

rebootIcon="system-reboot-symbolic"
shutdownIcon="system-shutdown-symbolic"

rebootEntry="$reboot\0icon\x1f$rebootIcon"
shutdownEntry="$shutdown\0icon\x1f$shutdownIcon"

rebootConfirmation="Yes, reboot"
shutdownConfirmation="Yes, shut down"
cancel="No, cancel"

rebootConfirmationEntry="$rebootConfirmation\0icon\x1f$rebootIcon"
shutdownConfirmationEntry="$shutdownConfirmation\0icon\x1f$shutdownIcon"
cancelEntry="$cancel\0icon\x1f$cancelIcon"

# Default options
show="$shutdownEntry\n$rebootEntry\n"
dryrun=false
# By default, ask for confirmation for actions that are irreversible
confirmReboot=true
confirmShutdown=true

# Parse command-line options
parsed=$(getopt --options=h --longoptions=help,dry-run,confirm:,choices:,choose: --name "$0" -- "$@")
if [ $? -ne 0 ]; then
    echo 'Terminating...' >&2
    exit 1
fi
eval set -- "$parsed"
unset parsed
while true; do
    case "$1" in
        "--dry-run")
            dryrun=true
            shift 1
            continue
            ;;
        "--confirm")
            confirmReboot=false
            confirmShutdown=false
            IFS='/' read -ra choices <<< "$2"
            for choice in "${choices[@]}"; do
                case $choice in
                    "reboot")
                        confirmReboot=true ;;
                    "shutdown")
                        confirmShutdown=true ;;
                    *)
                        echo "Invalid choice in --confirm: $choice" >&2
                        exit 1
                        ;;
                esac
            done
            shift 2
            continue
            ;;
        "--choices")
            IFS='/' read -ra choices <<< "$2"
            show=""
            for choice in "${choices[@]}"; do
                case $choice in
                    "reboot")
                        show="$show$rebootEntry\n" ;;
                    "shutdown")
                        show="$show$shutdownEntry\n" ;;
                    *)
                        echo "Invalid choice in --choices: $choice" >&2
                        exit 1
                        ;;
                esac
            done
            shift 2
            continue
            ;;
        "--choose")
            case $2 in
                "reboot")
                    selection=$reboot ;;
                "shutdown")
                    selection=$shutdown ;;
                *)
                    echo "Invalid choice in --choose: $2" >&2
                    exit 1
                    ;;
            esac
            shift 2
            continue
            ;;
        "--")
            shift
            break
            ;;
        *)
            echo "Internal error" >&2
            exit 1
            ;;
    esac
done

if [ -n "${@}" ]
then
    selection="${@}"
fi

printf "\0no-custom\x1ftrue\n"
if [ -z "$selection" ]
then
    echo -e "\0prompt\x1fPower menu"
    printf "$show"
else
    case $selection in
        $reboot)
            if [ $confirmReboot = true ]
            then
                echo -e "\0prompt\x1fAre you sure"
                echo -e $rebootConfirmationEntry
                echo -e $cancelEntry
                exit 0
            fi
            ;&  # resume to the next case
        $rebootConfirmation)
            if [ $dryrun = true ]
            then
                echo "Rebooting.." >&2
            else
                reboot &> /dev/null
            fi
            ;;
        $shutdown)
            if [ $confirmShutdown = true ]
            then
                echo -e "\0prompt\x1fAre you sure"
                echo -e $shutdownConfirmationEntry
                echo -e $cancelEntry
                exit 0
            fi
            ;&
        $shutdownConfirmation)
            if [ $dryrun = true ]
            then
                echo "Shutting down.." >&2
            else
                poweroff &> /dev/null
            fi
            ;;
        $cancel)
            exit 0
            ;;
        *)
            >&2 echo "Invalid selection: $selection"
            exit 1
            ;;
    esac
fi
